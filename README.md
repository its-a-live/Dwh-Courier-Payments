# Data Warehouse для расчётов с курьерами

Проект реализует ETL-процессы для построения витрины `cdm.dm_courier_ledger`, которая рассчитывает выплаты курьерам за предыдущий месяц на основе данных из API курьерской службы и подсистемы заказов.

## Структура проекта

### Слои DWH
1. **STG (Staging)**  
   - Сырые данные из API (курьеры, доставки) и подсистемы заказов.  
   - Таблицы: `stg.couriers`, `stg.deliveries`, `stg.bonussystem_events` и др.  
   - Данные сохраняются в формате JSON с ключевыми полями (`object_id`, `object_value`).

2. **DDS (Data Delivery Service)**  
   - Модель "снежинка" для аналитики.  
   - Таблицы: `dds.dm_couriers`, `dds.dm_orders`, `dds.fct_deliveries` и др.  
   - Связи между сущностями через внешние ключи.

3. **CDM (Common Data Model)**  
   - Готовая витрина `cdm.dm_courier_ledger` с расчётами:  
     - Количество заказов, сумма выплат, чаевые, рейтинг курьера.  
     - Формулы для расчёта вознаграждения на основе рейтинга.

### DAG-и в Airflow
- **STG-слой**:  
  - `couriers_dag.py`, `deliveries_dag.py` — загрузка данных из API с постраничным чтением.  
- **DDS-слой**:  
  - Обновление измерений (`dm_couriers`, `dm_orders`) и фактов (`fct_deliveries`).  
- **CDM-слой**:  
  - Витрина `dm_courier_ledger` с агрегацией за месяц.

## Технологии
- **Python**: Основной язык для ETL-логики.  
- **PostgreSQL**: Хранилище данных.  
- **Airflow**: Оркестрация DAG.  
- **Psycopg2**: Библиотека для работы с PostgreSQL.  
- **Pydantic**: Валидация данных.  
